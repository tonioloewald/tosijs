import{useState,useEffect}from"react";const settings={debug:!1,perf:!1},observerShouldBeRemoved=Symbol("observer should be removed"),listeners=[],touchedPaths=[];let updateTriggered=!1,resolveUpdate;const getPath=e=>"object"==typeof e?e._xinPath:e;class Listener{constructor(t,e){if("string"==typeof t)this.test=e=>"string"==typeof e&&!!e&&(t.startsWith(e)||e.startsWith(t));else if(t instanceof RegExp)this.test=t.test.bind(t);else{if(!(t instanceof Function))throw new Error("expect listener test to be a string, RegExp, or test function");this.test=t}if("function"!=typeof e)throw new Error("expect callback to be a path or function");this.callback=e,listeners.push(this)}}const update=()=>{settings.perf&&console.time("xin async update");for(const r of[...touchedPaths])listeners.filter(t=>{let e;try{e=t.test(r)}catch(e){throw new Error(`${t.test} threw "${e}" at "${r}"`)}return e===observerShouldBeRemoved?(unobserve(t),!1):!!e}).forEach(t=>{let e;try{e=t.callback(r)}catch(e){throw new Error(`${t.callback} threw "${e}" handling "${r}"`)}e===observerShouldBeRemoved&&unobserve(t)});touchedPaths.splice(0),updateTriggered=!1,resolveUpdate&&resolveUpdate(),settings.perf&&console.timeEnd("xin async update")},touch=e=>{const t=getPath(e);updateTriggered||(new Promise(e=>{resolveUpdate=e}),updateTriggered=setTimeout(update)),touchedPaths.find(e=>t.startsWith(e))||touchedPaths.push(t)},observe$1=(e,t)=>new Listener(e,t),unobserve=e=>{e=listeners.indexOf(e);if(-1<e)return listeners.splice(e,1),!1;throw new Error("unobserve failed, listener not found")},stringify=e=>{try{return JSON.stringify(e)}catch(e){return"{has circular references}"}},makeError=(...e)=>new Error(e.map(stringify).join(" ")),now36=()=>new Date(parseInt("1000000000",36)+Date.now()).valueOf().toString(36).slice(1);let _seq=0;const seq=()=>(parseInt("10000",36)+ ++_seq).toString(36).substr(-5),id=()=>now36()+seq(),_delete_={},_newObject_={};function pathParts(e){if(!e)return[];if(Array.isArray(e))return e;for(var t=[];e.length;){var r=e.search(/\[[^\]]+\]/);if(-1===r){t.push(e.split("."));break}var n=e.substr(0,r);e=e.substr(r),n&&t.push(n.split(".")),r=e.indexOf("]")+1,t.push(e.substr(1,r-2)),"."===e.substr(r,1)&&(r+=1),e=e.substr(r)}return t}const idPathMaps=new WeakMap;function buildIdPathValueMap(e,r){e&&!idPathMaps.get(e)&&idPathMaps.set(e,{}),idPathMaps.get(e)[r]||(idPathMaps.get(e)[r]={});const n=idPathMaps.get(e)[r];return"_auto_"===r?e.forEach((e,t)=>{void 0===e._auto_&&(e._auto_=id()),n[e._auto_+""]=t}):e.forEach((e,t)=>{n[getByPath(e,r)+""]=t}),n}function getIdPathMap(e,t){return idPathMaps.get(e)&&idPathMaps.get(e)[t]?idPathMaps.get(e)[t]:buildIdPathValueMap(e,t)}function keyToIndex(e,t,r){r+="";let n=getIdPathMap(e,t)[r];return n=void 0!==n&&getByPath(e[n],t)+""===r?n:buildIdPathValueMap(e,t)[r]}function byKey(e,t,r){return e[t]||(e[t]=r),e[t]}function byIdPath(e,t,r,n){let s=t?keyToIndex(e,t,r):r;if(n===_delete_)return e.splice(s,1),idPathMaps.delete(e),Symbol("deleted");if(n===_newObject_)t||e[s]||(e[s]={});else if(n)if(void 0!==s)e[s]=n;else{if(!t||getByPath(n,t)+""!=r+"")throw new Error(`byIdPath insert failed at [${t}=${r}]`);e.push(n),s=e.length-1}return e[s]}function expectArray(e){if(!Array.isArray(e))throw makeError("setByPath failed: expected array, found",e)}function expectObject(e){if(!e||e.constructor!==Object)throw makeError("setByPath failed: expected Object, found",e)}function getByPath(e,t){for(var r,n,s=pathParts(t),a=e,o=0,i=s.length;a&&o<i;o++){var c,l,u=s[o];if(Array.isArray(u))for(r=0,n=u.length;a&&r<n;r++)a=a[u[r]];else if(a.length)a=-1<u.indexOf("=")?([c,...l]=u.split("="),byIdPath(a,c,l.join("="))):a[r=parseInt(u,10)];else{if("="!==u[0])return;a=a[u.substr(1)]}}return a}function setByPath(e,t,r){let n=e;for(var s=pathParts(t);n&&s.length;){var a=s.shift();if("string"==typeof a){var o=a.indexOf("=");if(-1<o){(0===o?expectObject:expectArray)(n);var i=a.substr(0,o),o=a.substr(o+1);if(n=byIdPath(n,i,o,s.length?_newObject_:r),!s.length)return!0}else{expectArray(n);i=parseInt(a,10);if(!s.length){if(r!==_delete_){if(n[i]===r)return!1;n[i]=r}else n.splice(i,1);return!0}n=n[i]}}else{if(!Array.isArray(a)||!a.length)throw new Error("setByPath failed, bad path "+t);for(expectObject(n);a.length;){var c=a.shift();if(!a.length&&!s.length){if(r!==_delete_){if(n[c]===r)return!1;n[c]=r}else{if(!n.hasOwnProperty(c))return!1;delete n[c]}return!0}n=byKey(n,c,a.length?{}:[])}}}throw new Error(`setByPath(${e}, ${t}, ${r}) failed`)}const ARRAY_MUTATIONS=["sort","splice","copyWithin","fill","pop","push","reverse","shift","unshift"],registry={},validPath=/^\.?([^.[\](),])+(\.[^.[\](),]+|\[\d+\]|\[[^=[\](),]*=[^[\]()]+\])*$/,isValidPath=e=>validPath.test(e),extendPath=(e="",t="")=>""===e?t:t.match(/^\d+$/)||t.includes("=")?e+`[${t}]`:e+"."+t,regHandler=(i="")=>({get(t,e){if("symbol"==typeof e)return t[e];let r=e;var n,s,e=r.match(/^([^.[]+)\.(.+)$/)||r.match(/^([^\]]+)(\[.+)/)||r.match(/^(\[[^\]]+\])\.(.+)$/)||r.match(/^(\[[^\]]+\])\[(.+)$/);if(e)return[,e,n]=e,s=extendPath(i,e),(e=getByPath(t,e))&&"object"==typeof e?new Proxy(e,regHandler(s))[n]:e;if("_xinPath"===r)return i;if("_xinValue"===r)return t;if(r.startsWith("[")&&r.endsWith("]")&&(r=r.substr(1,r.length-2)),!Array.isArray(t)&&void 0!==t[r]||Array.isArray(t)&&r.includes("=")){let e;if(r.includes("=")){const[a,o]=r.split("=");e=t.find(e=>""+getByPath(e,a)===o)}else e=t[r];return e&&"object"==typeof e?(s=extendPath(i,r),new Proxy(e,regHandler(s))):"function"==typeof e?e.bind(t):e}return Array.isArray(t)?"function"==typeof(n=t[r])?(...e)=>{e=Array.prototype[r].apply(t,e);return ARRAY_MUTATIONS.includes(r)&&touch(i),e}:"object"==typeof n?new Proxy(n,regHandler(extendPath(i,r))):n:t?t[r]:void 0},set(e,t,r){r&&r._xinPath&&(r=r._xinValue);t=extendPath(i,t);if(isValidPath(t))return setByPath(registry,t,r)&&touch(t),!0;throw new Error("setting invalid path "+t)}}),observe=(e,t)=>{var r="function"==typeof t?t:xin[t];if("function"!=typeof r)throw new Error(`observe expects a function and ${t} is not a function nor is xin[${t}]`);return observe$1(e,r)},xin=new Proxy(registry,regHandler()),useXin=(t,e="")=>{const[r,n]=useState(xin[t]||e);useEffect(()=>{const e=observe(t,()=>{n(xin[t])});return()=>{unobserve(e)}});return[r,e=>{xin[t]=e}]},isAsync=e=>e&&e.constructor===(async()=>{}).constructor,describe=e=>null===e?"null":Array.isArray(e)?"array":"number"==typeof e&&isNaN(e)?"NaN":"string"==typeof e&&e.startsWith("#")?e:e instanceof Promise?"promise":"function"==typeof e?e.constructor===(async()=>{}).constructor?"async":"function":"object"==typeof e&&"Object"!==e.constructor.name?e.constructor.name:typeof e,parseFloatOrInfinity=e=>"-∞"===e?-1/0:"∞"===e[0]?1/0:parseFloat(e),inRange=(t,e)=>{let r,n;if(void 0!==t){try{[,r,n]=(t||"").match(/^([[(]-?[\d.\u221E]+)?,?(-?[\d.\u221E]+[\])])?$/)}catch(e){throw new Error("bad range "+t)}if(r){t=parseFloatOrInfinity(r.substr(1));if("("===r[0]){if(e<=t)return!1}else if(e<t)return!1}if(n){t=parseFloatOrInfinity(n);if(n.endsWith(")")){if(t<=e)return!1}else if(t<e)return!1}}return!0},regExps={},regexpTest=(e,t)=>{return(regExps[e]||(regExps[e]=new RegExp(e))).test(t)},isInstanceOf=(t,r)=>{if("function"==typeof r)return t instanceof Function;{let e=Object.getPrototypeOf(t);for(;e.constructor&&e.constructor!==Object;){if(e.constructor.name===r)return!0;e=Object.getPrototypeOf(e)}return!1}},specificTypeMatch=(e,t)=>{var[,r,n,,s]=e.match(/^#([?]?)([^\s]+)(\s(.*))?$/)||[];if(r&&null==t)return!0;var a=describe(t);switch(n){case"forbidden":return!1;case"any":return null!=t;case"native":return"function"!=typeof t||"function () { [native code] }"!==t.toString()?!1:!e||(isAsync(t)?e.match(/^async\b/):e.match(/^function\b/));case"function":return"function"!==a?!1:!0;case"number":return"number"!==a?!1:inRange(s,t);case"int":return"number"!==a||t!==Math.floor(t)?!1:inRange(s,t);case"union":return!!s.split("||").find(e=>specificTypeMatch("#"+e,t));case"enum":try{return s.split("|").map(JSON.parse).includes(t)}catch(e){throw new Error(`bad enum specification (${s}), expect JSON strings`)}case"void":return"undefined"===a||"null"===a;case"nothing":return"undefined"===a;case"string":return"string"===a;case"regexp":return"string"===a&&regexpTest(s,t);case"array":return Array.isArray(t);case"instance":return isInstanceOf(t,s);case"promise":return t instanceof Promise;case"object":return!!t&&"object"==typeof t&&!Array.isArray(t);default:if(a!==n)throw makeError("got",t,`expected "${e}", "${a}" does not match "${n}"`);return!0}},quoteIfString=e=>"string"==typeof e?`"${e}"`:"object"==typeof e?describe(e):e;function*arraySampler(e){let t=0;for(var r=Math.ceil(e.length/101);t<e.length;)t<5||t>e.length-5?(yield{sample:e[t],i:t},t++):(yield{sample:e[t],i:t},t=Math.min(t+r,e.length-4))}const matchType=(t,e,r=[],n="")=>{var s=describe(t),a=describe(e);if(s.startsWith("#")?specificTypeMatch(s,e):s===a)if("array"===s){a=!!e.length&&arraySampler(e);if(1===t.length&&a)for(var{sample:o,i}of a)matchType(t[0],o,r,`${n}[${i}]`);else if(1<t.length&&a)for(var{sample:c,i:l}of a){let e=!1;for(const u of t)if(0===matchType(u,c,[],"").length){e=!0;break}e||r.push(`${n}[${l}] had no matching type`)}}else"object"===s&&matchKeys(t,e,r,n);else r.push(`${n?n+" ":""}was ${quoteIfString(e)}, expected `+s);return r},legalVarName=/^[a-zA-Z_$][a-zA-Z_$0-9]*$/,matchKeys=(e,r,n=[],s="")=>{var a=new Set;for(const i of Object.keys(e))if(i.startsWith("#")){let t=legalVarName;try{"#"!==i&&(t=new RegExp(`^${i.substr(1)}$`))}catch(e){var o=`illegal regular expression in example key '${i}'`;throw n.push(o),makeError(o)}for(const c of Object.keys(r).filter(e=>t.test(e)))a.has(c)||(matchType(e[i],r[c],n,`${s}./^${i.substr(1)}$/:`+c),a.add(c))}else i.endsWith("?")?(o=i.substr(0,i.length-1),Object.hasOwnProperty.call(r,o)&&!a.has(o)&&(matchType(e[i],r[o],n,s+"."+o),a.add(o))):a.has(i)||(matchType(e[i],r[i],n,s+"."+i),a.add(i));return n};class TypeError{constructor(e){this.functionName=void 0,this.isParamFailure=!1,this.errors=[],Object.assign(this,e)}toString(){var{functionName:e,isParamFailure:t,errors:r}=this;return e+` failed: bad ${t?"parameter":"result"}, `+JSON.stringify(r)}}const assignReadOnly=(e,t)=>{t={...t};for(const r of Object.keys(t)){const n=t[r];Object.defineProperty(e,r,{enumerable:!0,get(){return n},set(e){throw new Error(r+" is read-only")}})}return e},matchParamTypes=(e,r)=>{for(let e=0;e<r.length;e++)if(r[e]instanceof TypeError)return r[e];e=e.map((e,t)=>matchType(e,r[t]));return e.flat().length?e:[]},typeSafe=(s,a=[],o=void 0,i=void 0)=>{if(matchParamTypes(["#function","#?array","#?any","#?string"],[s,a,o,i])instanceof TypeError)throw new Error("typeSafe was passed bad paramters");i=i||s.name||"anonymous";let c=0;return assignReadOnly(function(...e){c+=1;var t,r,n=matchParamTypes(a,e);return n instanceof TypeError?n:0===n.length?(t=s(...e),0===(r=matchType(o,t)).length?t:new TypeError({functionName:i,isParamFailure:!1,expected:o,found:t,errors:r})):new TypeError({functionName:i,isParamFailure:!0,expected:a,found:e,errors:n})},{paramTypes:a,resultType:o,getCallCount:()=>c})},filterArray=(e,t)=>{if(Array.isArray(t)){if(0===e.length)return[...t];var r=[];for(const s of t){var n=e.find(e=>0===matchType(e,s).length);void 0!==n&&r.push(filter(n,s))}return r}},filterObject=(e,t)=>{if(!matchType(e,t).length){var r={};for(const s of Object.keys(e)){var n=filter(e[s],t[s]);void 0!==n&&(r[s]=n)}return r}},filter=(e,t)=>{if(null!=t&&("object"==typeof t||!matchType(e,t).length))return Array.isArray(e)?filterArray(e,t):"object"==typeof t?filterObject(e,t):matchType(e,t).length?void 0:t},debounce=(t,r=250)=>{let n;return(...e)=>{n&&clearTimeout(n),n=setTimeout(()=>{t(...e)},r)}},hotReload=(n=()=>!0)=>{var e=localStorage.getItem("xin-state");if(e){var t=JSON.parse(e);for(const r of Object.keys(t).filter(n))xin[r]?Object.assign(xin[r],t[r]):xin[r]=t[r]}e=debounce(()=>{var e={},t=xin._xinValue;for(const r of Object.keys(t).filter(n))e[r]=t[r];localStorage.setItem("xin-state",JSON.stringify(e)),console.log("xin state saved to localStorage")},500);observe(n,e)},templates={},create=(e,...t)=>{templates[e]||(templates[e]=document.createElement(e));var r=templates[e].cloneNode();for(const a of t)if(a instanceof HTMLElement||"string"==typeof a||"number"==typeof a)(r instanceof HTMLTemplateElement?r.content:r).append(a);else for(const o of Object.keys(a)){var n,s=a[o];if("apply"===o)s(r);else if("style"===o)if("object"==typeof s)for(const i of Object.keys(s))r.style[i]=s[i];else r.setAttribute("style",s);else o.match(/^on[A-Z]/)?(n=o.substr(2).toLowerCase(),r.addEventListener(n,s)):(n=o.replace(/[A-Z]/g,e=>"-"+e.toLowerCase()),"boolean"==typeof s?s?r.setAttribute(n,""):r.removeAttribute(n):r.setAttribute(n,s))}return r},fragment=(...e)=>{var t=document.createDocumentFragment();for(const r of e)t.append(r);return t},_elements={fragment:fragment},elements=new Proxy(_elements,{get(e,t){if((t=t.replace(/[A-Z]/g,e=>"-"+e.toLocaleLowerCase())).match(/^\w+(-\w+)*$/))return e[t]||(e[t]=(...e)=>create(t,...e)),e[t];throw new Error(t+" does not appear to be a valid element tagName")},set(){throw new Error("You may not add new properties to elements")}}),dispatch=(e,t)=>{t=new Event(t);e.dispatchEvent(t)},resizeObserver=new ResizeObserver(e=>{for(const r of e){var t=r.target;dispatch(t,"resize")}}),appendContentToElement=(t,e)=>{if(e)if("string"==typeof e)t.textContent=e;else if(Array.isArray(e))e.forEach(e=>{t.appendChild(e.cloneNode?e.cloneNode(!0):e)});else{if(!e.cloneNode)throw new Error("expect text content or document node");t.appendChild(e.cloneNode(!0))}},hyphenated=e=>e.replace(/[A-Z]/g,e=>"-"+e.toLowerCase()),css=r=>{return"object"==typeof r?Object.keys(r).map(e=>{const t=r[e];return e+` {
${Object.keys(t).map(e=>`  ${hyphenated(e)}: ${t[e]};`).join("\n")}
}`}).join("\n\n"):r},defaultSpec={superClass:HTMLElement,style:{},methods:{},eventHandlers:{},props:{},attributes:{},content:elements.slot()},makeWebComponent=(e,t)=>{let{superClass:r,style:n,methods:s,eventHandlers:o,props:i,attributes:c,content:l,role:a}=Object.assign({},defaultSpec,t),u;var h;n&&(h=css(Object.assign({":host([hidden])":{display:"none !important"}},n)),u=elements.style(h));const f=class extends r{constructor(){super(),this._changeQueued=!1,this._renderQueued=!1;for(const r of Object.keys(i)){let t=i[r];"function"!=typeof t?Object.defineProperty(this,r,{enumerable:!1,get(){return t},set(e){e!==t&&(t=e,"value"===r&&(this.value=e),this.queueRender(!0))}}):Object.defineProperty(this,r,{enumerable:!1,get(){return t.call(this)},set(e){if(1!==t.length)throw new Error(`cannot set ${r}, it is read-only`);t.call(this,e)}})}const n=this;var e;this.elementRefs=new Proxy({},{get(e,t){if(!e[t]){var r=(n.shadowRoot||n).querySelector(`[data-ref="${t}"]`);if(!r)throw new Error(`elementRef "${t}" does not exist!`);r.removeAttribute("data-ref"),e[t]=r}return e[t]},set(){throw new Error("elementRefs is read-only")}}),u?((e=this.attachShadow({mode:"open"})).appendChild(u.cloneNode(!0)),appendContentToElement(e,l)):appendContentToElement(this,l),Object.keys(o).forEach(e=>{var t=!!e.startsWith("touch")&&{passive:!0};this.addEventListener(e,o[e].bind(this),t)}),o.childListChange&&new MutationObserver(o.childListChange.bind(this)).observe(this,{childList:!0});const s=Object.keys(c);if(s.length){const a={};new MutationObserver(e=>{let t=!1,r=!1;e.forEach(e=>{t="value"===e.attributeName,r=t||!(!e.attributeName||!s.includes(e.attributeName))}),r&&this.queueRender&&this.queueRender(t)}).observe(this,{attributes:!0}),s.forEach(t=>{Object.defineProperty(this,t,{enumerable:!1,get(){return"boolean"==typeof c[t]?this.hasAttribute(t):this.hasAttribute(t)?"number"==typeof c[t]?parseFloat(this.getAttribute(t)):this.getAttribute(t):(void 0!==a[t]?a:c)[t]},set(e){"boolean"==typeof c[t]?e!==this[t]&&(e?this.setAttribute(t,""):this.removeAttribute(t)):"number"==typeof c[t]?e!==parseFloat(this[t])&&this.setAttribute(t,e):"object"!=typeof e&&""+e==""+this[t]||(null==e||"object"==typeof e?this.removeAttribute(t):this.setAttribute(t,e),a[t]=e)}})})}this.queueRender()}queueRender(e=!1){this.render&&(this._changeQueued||(this._changeQueued=e),this._renderQueued||(this._renderQueued=!0,requestAnimationFrame(()=>{this._changeQueued&&dispatch(this,"change"),this._changeQueued=!1,this._renderQueued=!1,this.render()})))}connectedCallback(){a&&this.setAttribute("role",a),o.resize&&resizeObserver.observe(this),i.hasOwnProperty("value")&&(this.value=this.getAttribute("value")||null),t.connectedCallback&&t.connectedCallback.call(this)}disconnectedCallback(){resizeObserver.unobserve(this),t.disconnectedCallback&&t.disconnectedCallback.call(this)}render(){t.render&&t.render.call(this)}static defaultAttributes(){return{...c}}};return Object.keys(s).forEach(e=>{f.prototype[e]=s[e]}),window.customElements&&window.customElements.define(e,f),elements[e]};export{elements,filter,hotReload,makeWebComponent,matchType,observe,observerShouldBeRemoved,settings,touch,typeSafe,unobserve,useXin,xin};
//# sourceMappingURL=dist/index.min.mjs.map